<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Công cụ tính thuế thu nhập cá nhân 2026 - Tính lương Gross sang Net và ngược lại">
  <title>Tính Thuế Thu Nhập Cá Nhân 2026</title>

  <!-- Google Fonts - Be Vietnam Pro -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* CSS Custom Properties */
    :root {
      /* Colors */
      --color-primary: #2563eb;
      --color-primary-dark: #1d4ed8;
      --color-success: #16a34a;
      --color-error: #dc2626;
      --color-bg: #f8fafc;
      --color-surface: #ffffff;
      --color-text: #1e293b;
      --color-text-muted: #64748b;
      --color-border: #e2e8f0;

      /* Typography */
      --font-family: 'Be Vietnam Pro', system-ui, -apple-system, sans-serif;
      --font-size-base: 16px;
      --line-height: 1.6;

      /* Spacing */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;

      /* Touch targets (WCAG 2.2) */
      --touch-target: 44px;

      /* Border radius */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
    }

    /* CSS Reset */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: var(--font-size-base);
    }

    body {
      font-family: var(--font-family);
      line-height: var(--line-height);
      color: var(--color-text);
      background: var(--color-bg);
      min-height: 100vh;
      padding: var(--space-md);
    }

    /* Calculator Container */
    .calculator {
      max-width: 600px;
      margin: 0 auto;
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      padding: var(--space-lg);
    }

    /* Header */
    .calc-header {
      text-align: center;
      margin-bottom: var(--space-lg);
    }

    .calc-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-text);
      margin-bottom: var(--space-xs);
    }

    .calc-header .subtitle {
      font-size: 0.875rem;
      color: var(--color-text-muted);
    }

    /* Form Styles */
    fieldset {
      border: none;
      margin-bottom: var(--space-lg);
    }

    legend {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-md);
    }

    /* Results Section */
    #results {
      margin-top: var(--space-lg);
      padding-top: var(--space-lg);
      border-top: 1px solid var(--color-border);
    }

    /* Responsive Design */
    @media (max-width: 480px) {
      body {
        padding: var(--space-sm);
      }

      .calculator {
        padding: var(--space-md);
        border-radius: var(--radius-md);
      }

      .calc-header h1 {
        font-size: 1.25rem;
      }
    }

    /* Screen reader only utility */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }
  </style>
</head>
<body>
  <main class="calculator">
    <header class="calc-header">
      <h1>Tính Thuế Thu Nhập Cá Nhân 2026</h1>
      <p class="subtitle">Công cụ tính lương Gross ↔ Net theo luật thuế mới</p>
    </header>

    <form id="calc-form" novalidate>
      <fieldset>
        <legend>Thông tin thu nhập</legend>
        <!-- Input fields will be added in Phase 03 -->
        <p style="color: var(--color-text-muted); font-size: 0.875rem;">
          Các trường nhập liệu sẽ được thêm trong giai đoạn tiếp theo.
        </p>
      </fieldset>

      <fieldset>
        <legend>Cài đặt</legend>
        <!-- Region, dependents will be added in Phase 03 -->
        <p style="color: var(--color-text-muted); font-size: 0.875rem;">
          Cài đặt vùng lương và người phụ thuộc sẽ được thêm sau.
        </p>
      </fieldset>
    </form>

    <section id="results" aria-live="polite">
      <!-- Output will be added in Phase 03 -->
      <p style="color: var(--color-text-muted); font-size: 0.875rem; text-align: center;">
        Kết quả tính toán sẽ hiển thị ở đây.
      </p>
    </section>
  </main>

  <script>
    /**
     * VND Currency Formatting Utility
     * Handles Vietnamese Dong formatting and parsing
     */
    const VND = {
      formatter: new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND',
        maximumFractionDigits: 0
      }),

      /**
       * Format a number as VND currency string
       * @param {number} amount - The amount to format
       * @returns {string} Formatted VND string (e.g., "1.000.000 ₫")
       */
      format(amount) {
        if (typeof amount !== 'number' || isNaN(amount)) {
          return this.formatter.format(0);
        }
        return this.formatter.format(Math.round(amount));
      },

      /**
       * Parse a VND currency string to number
       * @param {string} str - The string to parse (e.g., "1.000.000 ₫")
       * @returns {number} Parsed number value
       */
      parse(str) {
        if (typeof str !== 'string') {
          return 0;
        }
        // Remove VND symbol (₫), spaces, and dot separators
        const cleaned = str.replace(/[^\d-]/g, '');
        return parseInt(cleaned, 10) || 0;
      }
    };

    // Export VND utility to window for testing and Phase 02/03 usage
    window.VND = VND;

    /**
     * TAX Constants - Vietnam 2026 Tax Law
     * Effective from January 1, 2026
     */
    const TAX = {
      // 2026 Progressive Tax Brackets (5 levels)
      BRACKETS: [
        { upper: 10_000_000, rate: 0.05 },
        { upper: 30_000_000, rate: 0.10 },
        { upper: 60_000_000, rate: 0.20 },
        { upper: 100_000_000, rate: 0.30 },
        { upper: Infinity, rate: 0.35 }
      ],

      // Deductions (VND/month)
      PERSONAL_DEDUCTION: 15_500_000,
      DEPENDENT_DEDUCTION: 6_200_000,

      // Insurance Rates (employee portion)
      INSURANCE: {
        SOCIAL: 0.08,      // 8%
        HEALTH: 0.015,     // 1.5%
        UNEMPLOYMENT: 0.01 // 1%
      },

      // Regional Minimum Wages 2026 (VND)
      REGIONS: {
        I: { name: 'Vùng I', minWage: 5_310_000 },
        II: { name: 'Vùng II', minWage: 4_730_000 },
        III: { name: 'Vùng III', minWage: 4_140_000 },
        IV: { name: 'Vùng IV', minWage: 3_700_000 }
      },

      // National minimum wage (for social/health caps)
      NATIONAL_MIN_WAGE: 5_310_000,

      // Cap multiplier (20x minimum wage)
      CAP_MULTIPLIER: 20
    };

    /**
     * Calculate progressive income tax
     * @param {number} taxableIncome - Income after deductions
     * @returns {number} Tax amount (rounded to VND)
     */
    function calculateTax(taxableIncome) {
      if (taxableIncome <= 0) return 0;

      let totalTax = 0;
      let previousUpper = 0;

      for (const bracket of TAX.BRACKETS) {
        if (taxableIncome > bracket.upper) {
          // Full bracket
          totalTax += (bracket.upper - previousUpper) * bracket.rate;
          previousUpper = bracket.upper;
        } else {
          // Partial bracket (last applicable)
          totalTax += (taxableIncome - previousUpper) * bracket.rate;
          break;
        }
      }

      return Math.round(totalTax);
    }

    /**
     * Calculate insurance contributions with regional caps
     * @param {number} grossIncome - Gross salary
     * @param {string} regionKey - Region key (I, II, III, IV)
     * @returns {Object} Insurance breakdown {social, health, unemployment, total}
     */
    function calculateInsurance(grossIncome, regionKey) {
      const region = TAX.REGIONS[regionKey];
      if (!region) {
        return { social: 0, health: 0, unemployment: 0, total: 0 };
      }

      const nationalCap = TAX.NATIONAL_MIN_WAGE * TAX.CAP_MULTIPLIER;
      const regionalCap = region.minWage * TAX.CAP_MULTIPLIER;

      // Calculate each with individual caps
      const social = Math.min(
        grossIncome * TAX.INSURANCE.SOCIAL,
        nationalCap * TAX.INSURANCE.SOCIAL
      );

      const health = Math.min(
        grossIncome * TAX.INSURANCE.HEALTH,
        nationalCap * TAX.INSURANCE.HEALTH
      );

      const unemployment = Math.min(
        grossIncome * TAX.INSURANCE.UNEMPLOYMENT,
        regionalCap * TAX.INSURANCE.UNEMPLOYMENT
      );

      return {
        social: Math.round(social),
        health: Math.round(health),
        unemployment: Math.round(unemployment),
        total: Math.round(social + health + unemployment)
      };
    }

    /**
     * Calculate total deductions (personal + dependents)
     * @param {number} numDependents - Number of dependents
     * @returns {number} Total deduction amount
     */
    function calculateDeductions(numDependents) {
      const personal = TAX.PERSONAL_DEDUCTION;
      const dependent = TAX.DEPENDENT_DEDUCTION * Math.max(0, numDependents);
      return personal + dependent;
    }

    /**
     * Convert gross salary to net salary
     * @param {number} grossIncome - Gross salary
     * @param {number} numDependents - Number of dependents
     * @param {string} regionKey - Region key (I, II, III, IV)
     * @returns {Object} Complete tax calculation result
     */
    function grossToNet(grossIncome, numDependents, regionKey) {
      const insurance = calculateInsurance(grossIncome, regionKey);
      const deductions = calculateDeductions(numDependents);

      // Taxable income = Gross - Insurance - Deductions (floor at 0)
      const taxableIncome = Math.max(0, grossIncome - insurance.total - deductions);
      const tax = calculateTax(taxableIncome);

      // Net = Gross - Insurance - Tax
      const netIncome = grossIncome - insurance.total - tax;

      // Effective rate (avoid division by zero)
      const effectiveRate = grossIncome > 0
        ? (tax / grossIncome) * 100
        : 0;

      return {
        grossIncome: Math.round(grossIncome),
        insurance,
        deductions,
        taxableIncome,
        tax,
        netIncome: Math.round(netIncome),
        effectiveRate: effectiveRate.toFixed(2)
      };
    }

    /**
     * Convert net salary to gross salary using binary search
     * @param {number} targetNet - Target net salary
     * @param {number} numDependents - Number of dependents
     * @param {string} regionKey - Region key (I, II, III, IV)
     * @returns {Object} Complete tax calculation result
     */
    function netToGross(targetNet, numDependents, regionKey) {
      const EPSILON = 100; // VND precision tolerance
      const MAX_ITERATIONS = 50;

      // Edge case: very low or zero net
      if (targetNet <= 0) {
        return grossToNet(0, numDependents, regionKey);
      }

      // Binary search bounds
      let low = targetNet;
      let high = targetNet * 2.5; // Account for ~60% max effective deduction

      for (let i = 0; i < MAX_ITERATIONS; i++) {
        const mid = (low + high) / 2;
        const result = grossToNet(mid, numDependents, regionKey);
        const diff = result.netIncome - targetNet;

        if (Math.abs(diff) <= EPSILON) {
          return result;
        }

        if (diff < 0) {
          low = mid;
        } else {
          high = mid;
        }
      }

      // Return best approximation
      return grossToNet((low + high) / 2, numDependents, regionKey);
    }

    /**
     * Validate calculation inputs
     * @param {number} salary - Salary amount
     * @param {number} numDependents - Number of dependents
     * @param {string} regionKey - Region key
     * @returns {Object} Validation result {valid, errors}
     */
    function validateInputs(salary, numDependents, regionKey) {
      const errors = [];

      if (typeof salary !== 'number' || isNaN(salary)) {
        errors.push('Vui lòng nhập số tiền hợp lệ');
      } else if (salary < 0) {
        errors.push('Số tiền không được âm');
      } else if (salary > 10_000_000_000) {
        errors.push('Số tiền vượt quá giới hạn (10 tỷ VND)');
      }

      if (!Number.isInteger(numDependents) || numDependents < 0) {
        errors.push('Số người phụ thuộc không hợp lệ');
      } else if (numDependents > 10) {
        errors.push('Số người phụ thuộc tối đa là 10');
      }

      if (!TAX.REGIONS[regionKey]) {
        errors.push('Vùng lương không hợp lệ');
      }

      return { valid: errors.length === 0, errors };
    }

    /**
     * Get detailed tax bracket breakdown for UI display
     * @param {number} taxableIncome - Taxable income
     * @returns {Array} Breakdown by bracket
     */
    function getTaxBreakdown(taxableIncome) {
      if (taxableIncome <= 0) return [];

      const breakdown = [];
      let previousUpper = 0;

      for (const bracket of TAX.BRACKETS) {
        if (taxableIncome > previousUpper) {
          const taxableInBracket = Math.min(
            taxableIncome - previousUpper,
            bracket.upper - previousUpper
          );
          const taxInBracket = taxableInBracket * bracket.rate;

          breakdown.push({
            range: `${VND.format(previousUpper)} - ${bracket.upper === Infinity ? '...' : VND.format(bracket.upper)}`,
            rate: `${bracket.rate * 100}%`,
            taxable: taxableInBracket,
            tax: Math.round(taxInBracket)
          });

          previousUpper = bracket.upper;
          if (taxableIncome <= bracket.upper) break;
        }
      }

      return breakdown;
    }

    // Export all functions to window for testing and Phase 03 usage
    window.TAX = TAX;
    window.calculateTax = calculateTax;
    window.calculateInsurance = calculateInsurance;
    window.calculateDeductions = calculateDeductions;
    window.grossToNet = grossToNet;
    window.netToGross = netToGross;
    window.validateInputs = validateInputs;
    window.getTaxBreakdown = getTaxBreakdown;
  </script>
</body>
</html>
