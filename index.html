<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Công cụ tính thuế thu nhập cá nhân 2026 - Tính lương Gross sang Net và ngược lại">
  <title>Tính Thuế Thu Nhập Cá Nhân 2026</title>

  <!-- Google Fonts - Be Vietnam Pro -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* CSS Custom Properties */
    :root {
      /* Colors */
      --color-primary: #2563eb;
      --color-primary-dark: #1d4ed8;
      --color-success: #16a34a;
      --color-error: #dc2626;
      --color-bg: #f8fafc;
      --color-surface: #ffffff;
      --color-text: #1e293b;
      --color-text-muted: #64748b;
      --color-border: #e2e8f0;

      /* Typography */
      --font-family: 'Be Vietnam Pro', system-ui, -apple-system, sans-serif;
      --font-size-base: 16px;
      --line-height: 1.6;

      /* Spacing */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;

      /* Touch targets (WCAG 2.2) */
      --touch-target: 44px;

      /* Border radius */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
    }

    /* CSS Reset */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: var(--font-size-base);
    }

    body {
      font-family: var(--font-family);
      line-height: var(--line-height);
      color: var(--color-text);
      background: var(--color-bg);
      min-height: 100vh;
      padding: var(--space-md);
    }

    /* Calculator Container */
    .calculator {
      max-width: 600px;
      margin: 0 auto;
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      padding: var(--space-lg);
    }

    /* Header */
    .calc-header {
      text-align: center;
      margin-bottom: var(--space-lg);
    }

    .calc-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-text);
      margin-bottom: var(--space-xs);
    }

    .calc-header .subtitle {
      font-size: 0.875rem;
      color: var(--color-text-muted);
    }

    /* Mode Toggle */
    .mode-toggle {
      display: flex;
      gap: var(--space-xs);
      background: var(--color-bg);
      padding: var(--space-xs);
      border-radius: var(--radius-md);
      margin-top: var(--space-md);
    }

    .mode-btn {
      flex: 1;
      padding: var(--space-sm) var(--space-md);
      border: none;
      border-radius: var(--radius-sm);
      background: transparent;
      color: var(--color-text-muted);
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      min-height: var(--touch-target);
      transition: all 0.2s ease;
    }

    .mode-btn.active {
      background: var(--color-primary);
      color: white;
      box-shadow: 0 2px 4px rgb(37 99 235 / 0.3);
    }

    .mode-btn:hover:not(.active) {
      background: var(--color-border);
    }

    /* Form Styles */
    fieldset {
      border: none;
      margin-bottom: var(--space-lg);
    }

    legend {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-md);
    }

    /* Form Fields */
    .form-field {
      margin-bottom: var(--space-lg);
    }

    .form-field label {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: var(--space-sm);
    }

    .label-text {
      font-weight: 600;
      color: var(--color-text);
    }

    .label-hint {
      font-size: 0.75rem;
      color: var(--color-text-muted);
    }

    .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-wrapper input,
    select {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      padding-right: 40px;
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: 1.125rem;
      font-weight: 500;
      min-height: var(--touch-target);
      transition: border-color 0.2s;
    }

    .input-wrapper input:focus,
    select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
    }

    .input-suffix {
      position: absolute;
      right: var(--space-md);
      color: var(--color-text-muted);
      font-weight: 500;
      pointer-events: none;
    }

    /* Counter Input */
    .counter-input {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .counter-input input {
      width: 60px;
      text-align: center;
      padding: var(--space-sm);
      padding-right: var(--space-sm);
      -moz-appearance: textfield;
    }

    .counter-input input::-webkit-outer-spin-button,
    .counter-input input::-webkit-inner-spin-button {
      -webkit-appearance: none;
    }

    .counter-btn {
      width: var(--touch-target);
      height: var(--touch-target);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text);
      cursor: pointer;
      transition: all 0.2s;
    }

    .counter-btn:hover {
      background: var(--color-bg);
      border-color: var(--color-primary);
    }

    .counter-btn:active {
      transform: scale(0.95);
    }

    /* Error State */
    .error-text {
      display: block;
      min-height: 1.25rem;
      margin-top: var(--space-xs);
      font-size: 0.75rem;
      color: var(--color-error);
    }

    .form-field.has-error input {
      border-color: var(--color-error);
    }

    /* Results Section */
    .results-section {
      margin-top: var(--space-xl);
      padding-top: var(--space-lg);
      border-top: 1px solid var(--color-border);
    }

    .result-primary {
      text-align: center;
      padding: var(--space-lg);
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
      border-radius: var(--radius-lg);
      color: white;
      margin-bottom: var(--space-lg);
    }

    .result-label {
      display: block;
      font-size: 0.875rem;
      opacity: 0.9;
      margin-bottom: var(--space-xs);
    }

    .result-value {
      display: block;
      font-size: 2rem;
      font-weight: 700;
    }

    .result-breakdown h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: var(--space-md);
      color: var(--color-text);
    }

    .breakdown-group {
      margin-bottom: var(--space-lg);
    }

    .breakdown-group h3 {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
      margin-bottom: var(--space-sm);
    }

    .breakdown-list {
      background: var(--color-bg);
      border-radius: var(--radius-md);
      padding: var(--space-sm);
    }

    .breakdown-item {
      display: flex;
      justify-content: space-between;
      padding: var(--space-sm);
    }

    .breakdown-item dt {
      color: var(--color-text-muted);
    }

    .breakdown-item dd {
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }

    .breakdown-item.total {
      border-top: 1px solid var(--color-border);
      margin-top: var(--space-xs);
      padding-top: var(--space-sm);
    }

    .breakdown-item.total dt,
    .breakdown-item.total dd {
      font-weight: 600;
      color: var(--color-text);
    }

    /* Tax Bracket Details */
    .tax-brackets {
      margin-top: var(--space-lg);
    }

    .tax-brackets summary {
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--color-primary);
      font-weight: 500;
    }

    .tax-brackets table {
      width: 100%;
      margin-top: var(--space-md);
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .tax-brackets th,
    .tax-brackets td {
      padding: var(--space-sm);
      text-align: left;
      border-bottom: 1px solid var(--color-border);
    }

    .tax-brackets th {
      font-weight: 600;
      color: var(--color-text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
    }

    .tax-brackets td:last-child {
      text-align: right;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }

    /* Responsive Design */
    @media (max-width: 480px) {
      body {
        padding: var(--space-sm);
      }

      .calculator {
        padding: var(--space-md);
        border-radius: var(--radius-md);
      }

      .calc-header h1 {
        font-size: 1.25rem;
      }

      .result-value {
        font-size: 1.5rem;
      }

      .breakdown-item {
        flex-direction: column;
        gap: var(--space-xs);
      }

      .breakdown-item dd {
        text-align: left;
      }

      .tax-brackets table {
        font-size: 0.75rem;
      }

      .tax-brackets th,
      .tax-brackets td {
        padding: var(--space-xs);
      }
    }

    /* Screen reader only utility */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }
  </style>
</head>
<body>
  <main class="calculator">
    <header class="calc-header">
      <h1>Tính Thuế Thu Nhập Cá Nhân 2026</h1>
      <p class="subtitle">Công cụ tính lương Gross ↔ Net theo luật thuế mới</p>

      <div class="mode-toggle" role="group" aria-label="Chọn chế độ tính">
        <button type="button" class="mode-btn active" data-mode="gross-to-net">
          Gross → Net
        </button>
        <button type="button" class="mode-btn" data-mode="net-to-gross">
          Net → Gross
        </button>
      </div>
    </header>

    <form id="calc-form" novalidate>
      <fieldset class="input-group">
        <legend class="sr-only">Thông tin thu nhập</legend>

        <!-- Salary Input -->
        <div class="form-field">
          <label for="salary" id="salary-label">
            <span class="label-text">Lương <span id="salary-type">Gross</span></span>
            <span class="label-hint">VND/tháng</span>
          </label>
          <div class="input-wrapper">
            <input
              type="text"
              id="salary"
              inputmode="numeric"
              aria-labelledby="salary-label"
              aria-describedby="salary-error"
              placeholder="Nhập số tiền"
              autocomplete="off"
            >
            <span class="input-suffix">₫</span>
          </div>
          <span id="salary-error" class="error-text" role="alert"></span>
        </div>

        <!-- Dependents -->
        <div class="form-field">
          <label for="dependents">
            <span class="label-text">Số người phụ thuộc</span>
            <span class="label-hint">Giảm trừ 6.200.000₫/người</span>
          </label>
          <div class="counter-input">
            <button type="button" class="counter-btn" data-action="decrement" aria-label="Giảm">−</button>
            <input
              type="number"
              id="dependents"
              value="0"
              min="0"
              max="10"
              aria-label="Số người phụ thuộc"
            >
            <button type="button" class="counter-btn" data-action="increment" aria-label="Tăng">+</button>
          </div>
        </div>

        <!-- Region -->
        <div class="form-field">
          <label for="region">
            <span class="label-text">Vùng lương tối thiểu</span>
            <span class="label-hint">Ảnh hưởng mức đóng BHXH</span>
          </label>
          <select id="region" aria-label="Chọn vùng lương">
            <option value="I">Vùng I - 5.310.000₫</option>
            <option value="II">Vùng II - 4.730.000₫</option>
            <option value="III">Vùng III - 4.140.000₫</option>
            <option value="IV">Vùng IV - 3.700.000₫</option>
          </select>
        </div>
      </fieldset>
    </form>

    <section id="results" class="results-section" aria-live="polite">
      <div class="result-primary">
        <span class="result-label" id="result-label">Lương Net</span>
        <span class="result-value" id="result-value" aria-labelledby="result-label">0 ₫</span>
      </div>

      <div class="result-breakdown">
        <h2>Chi tiết</h2>

        <div class="breakdown-group">
          <h3>Bảo hiểm bắt buộc</h3>
          <dl class="breakdown-list">
            <div class="breakdown-item">
              <dt>BHXH (8%)</dt>
              <dd id="ins-social">0 ₫</dd>
            </div>
            <div class="breakdown-item">
              <dt>BHYT (1.5%)</dt>
              <dd id="ins-health">0 ₫</dd>
            </div>
            <div class="breakdown-item">
              <dt>BHTN (1%)</dt>
              <dd id="ins-unemployment">0 ₫</dd>
            </div>
            <div class="breakdown-item total">
              <dt>Tổng BH</dt>
              <dd id="ins-total">0 ₫</dd>
            </div>
          </dl>
        </div>

        <div class="breakdown-group">
          <h3>Giảm trừ</h3>
          <dl class="breakdown-list">
            <div class="breakdown-item">
              <dt>Bản thân</dt>
              <dd id="ded-personal">15.500.000 ₫</dd>
            </div>
            <div class="breakdown-item">
              <dt>Người phụ thuộc</dt>
              <dd id="ded-dependents">0 ₫</dd>
            </div>
            <div class="breakdown-item total">
              <dt>Tổng giảm trừ</dt>
              <dd id="ded-total">15.500.000 ₫</dd>
            </div>
          </dl>
        </div>

        <div class="breakdown-group">
          <h3>Thuế TNCN</h3>
          <dl class="breakdown-list">
            <div class="breakdown-item">
              <dt>Thu nhập chịu thuế</dt>
              <dd id="taxable-income">0 ₫</dd>
            </div>
            <div class="breakdown-item">
              <dt>Thuế phải nộp</dt>
              <dd id="tax-amount">0 ₫</dd>
            </div>
            <div class="breakdown-item">
              <dt>Thuế suất thực tế</dt>
              <dd id="tax-rate">0%</dd>
            </div>
          </dl>
        </div>
      </div>

      <!-- Tax Bracket Table -->
      <details class="tax-brackets">
        <summary>Xem chi tiết biểu thuế lũy tiến</summary>
        <table id="bracket-table">
          <thead>
            <tr>
              <th>Bậc</th>
              <th>Thu nhập</th>
              <th>Thuế suất</th>
              <th>Thuế</th>
            </tr>
          </thead>
          <tbody id="bracket-body">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </details>
    </section>
  </main>

  <script>
    /**
     * VND Currency Formatting Utility
     * Handles Vietnamese Dong formatting and parsing
     */
    const VND = {
      formatter: new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND',
        maximumFractionDigits: 0
      }),

      /**
       * Format a number as VND currency string
       * @param {number} amount - The amount to format
       * @returns {string} Formatted VND string (e.g., "1.000.000 ₫")
       */
      format(amount) {
        if (typeof amount !== 'number' || isNaN(amount)) {
          return this.formatter.format(0);
        }
        return this.formatter.format(Math.round(amount));
      },

      /**
       * Parse a VND currency string to number
       * @param {string} str - The string to parse (e.g., "1.000.000 ₫")
       * @returns {number} Parsed number value
       */
      parse(str) {
        if (typeof str !== 'string') {
          return 0;
        }
        // Remove VND symbol (₫), spaces, and dot separators
        const cleaned = str.replace(/[^\d-]/g, '');
        return parseInt(cleaned, 10) || 0;
      }
    };

    // Export VND utility to window for testing and Phase 02/03 usage
    window.VND = VND;

    /**
     * TAX Constants - Vietnam 2026 Tax Law
     * Effective from January 1, 2026
     */
    const TAX = {
      // 2026 Progressive Tax Brackets (5 levels)
      BRACKETS: [
        { upper: 10_000_000, rate: 0.05 },
        { upper: 30_000_000, rate: 0.10 },
        { upper: 60_000_000, rate: 0.20 },
        { upper: 100_000_000, rate: 0.30 },
        { upper: Infinity, rate: 0.35 }
      ],

      // Deductions (VND/month)
      PERSONAL_DEDUCTION: 15_500_000,
      DEPENDENT_DEDUCTION: 6_200_000,

      // Insurance Rates (employee portion)
      INSURANCE: {
        SOCIAL: 0.08,      // 8%
        HEALTH: 0.015,     // 1.5%
        UNEMPLOYMENT: 0.01 // 1%
      },

      // Regional Minimum Wages 2026 (VND)
      REGIONS: {
        I: { name: 'Vùng I', minWage: 5_310_000 },
        II: { name: 'Vùng II', minWage: 4_730_000 },
        III: { name: 'Vùng III', minWage: 4_140_000 },
        IV: { name: 'Vùng IV', minWage: 3_700_000 }
      },

      // National minimum wage (for social/health caps)
      NATIONAL_MIN_WAGE: 5_310_000,

      // Cap multiplier (20x minimum wage)
      CAP_MULTIPLIER: 20
    };

    /**
     * Calculate progressive income tax
     * @param {number} taxableIncome - Income after deductions
     * @returns {number} Tax amount (rounded to VND)
     */
    function calculateTax(taxableIncome) {
      if (taxableIncome <= 0) return 0;

      let totalTax = 0;
      let previousUpper = 0;

      for (const bracket of TAX.BRACKETS) {
        if (taxableIncome > bracket.upper) {
          // Full bracket
          totalTax += (bracket.upper - previousUpper) * bracket.rate;
          previousUpper = bracket.upper;
        } else {
          // Partial bracket (last applicable)
          totalTax += (taxableIncome - previousUpper) * bracket.rate;
          break;
        }
      }

      return Math.round(totalTax);
    }

    /**
     * Calculate insurance contributions with regional caps
     * @param {number} grossIncome - Gross salary
     * @param {string} regionKey - Region key (I, II, III, IV)
     * @returns {Object} Insurance breakdown {social, health, unemployment, total}
     */
    function calculateInsurance(grossIncome, regionKey) {
      const region = TAX.REGIONS[regionKey];
      if (!region) {
        return { social: 0, health: 0, unemployment: 0, total: 0 };
      }

      const nationalCap = TAX.NATIONAL_MIN_WAGE * TAX.CAP_MULTIPLIER;
      const regionalCap = region.minWage * TAX.CAP_MULTIPLIER;

      // Calculate each with individual caps
      const social = Math.min(
        grossIncome * TAX.INSURANCE.SOCIAL,
        nationalCap * TAX.INSURANCE.SOCIAL
      );

      const health = Math.min(
        grossIncome * TAX.INSURANCE.HEALTH,
        nationalCap * TAX.INSURANCE.HEALTH
      );

      const unemployment = Math.min(
        grossIncome * TAX.INSURANCE.UNEMPLOYMENT,
        regionalCap * TAX.INSURANCE.UNEMPLOYMENT
      );

      return {
        social: Math.round(social),
        health: Math.round(health),
        unemployment: Math.round(unemployment),
        total: Math.round(social + health + unemployment)
      };
    }

    /**
     * Calculate total deductions (personal + dependents)
     * @param {number} numDependents - Number of dependents
     * @returns {number} Total deduction amount
     */
    function calculateDeductions(numDependents) {
      const personal = TAX.PERSONAL_DEDUCTION;
      const dependent = TAX.DEPENDENT_DEDUCTION * Math.max(0, numDependents);
      return personal + dependent;
    }

    /**
     * Convert gross salary to net salary
     * @param {number} grossIncome - Gross salary
     * @param {number} numDependents - Number of dependents
     * @param {string} regionKey - Region key (I, II, III, IV)
     * @returns {Object} Complete tax calculation result
     */
    function grossToNet(grossIncome, numDependents, regionKey) {
      const insurance = calculateInsurance(grossIncome, regionKey);
      const deductions = calculateDeductions(numDependents);

      // Taxable income = Gross - Insurance - Deductions (floor at 0)
      const taxableIncome = Math.max(0, grossIncome - insurance.total - deductions);
      const tax = calculateTax(taxableIncome);

      // Net = Gross - Insurance - Tax
      const netIncome = grossIncome - insurance.total - tax;

      // Effective rate (avoid division by zero)
      const effectiveRate = grossIncome > 0
        ? (tax / grossIncome) * 100
        : 0;

      return {
        grossIncome: Math.round(grossIncome),
        insurance,
        deductions,
        taxableIncome,
        tax,
        netIncome: Math.round(netIncome),
        effectiveRate: effectiveRate.toFixed(2)
      };
    }

    /**
     * Convert net salary to gross salary using binary search
     * @param {number} targetNet - Target net salary
     * @param {number} numDependents - Number of dependents
     * @param {string} regionKey - Region key (I, II, III, IV)
     * @returns {Object} Complete tax calculation result
     */
    function netToGross(targetNet, numDependents, regionKey) {
      const EPSILON = 100; // VND precision tolerance
      const MAX_ITERATIONS = 50;

      // Edge case: very low or zero net
      if (targetNet <= 0) {
        return grossToNet(0, numDependents, regionKey);
      }

      // Binary search bounds
      let low = targetNet;
      let high = targetNet * 2.5; // Account for ~60% max effective deduction

      for (let i = 0; i < MAX_ITERATIONS; i++) {
        const mid = (low + high) / 2;
        const result = grossToNet(mid, numDependents, regionKey);
        const diff = result.netIncome - targetNet;

        if (Math.abs(diff) <= EPSILON) {
          return result;
        }

        if (diff < 0) {
          low = mid;
        } else {
          high = mid;
        }
      }

      // Return best approximation
      return grossToNet((low + high) / 2, numDependents, regionKey);
    }

    /**
     * Validate calculation inputs
     * @param {number} salary - Salary amount
     * @param {number} numDependents - Number of dependents
     * @param {string} regionKey - Region key
     * @returns {Object} Validation result {valid, errors}
     */
    function validateInputs(salary, numDependents, regionKey) {
      const errors = [];

      if (typeof salary !== 'number' || isNaN(salary)) {
        errors.push('Vui lòng nhập số tiền hợp lệ');
      } else if (salary < 0) {
        errors.push('Số tiền không được âm');
      } else if (salary > 10_000_000_000) {
        errors.push('Số tiền vượt quá giới hạn (10 tỷ VND)');
      }

      if (!Number.isInteger(numDependents) || numDependents < 0) {
        errors.push('Số người phụ thuộc không hợp lệ');
      } else if (numDependents > 10) {
        errors.push('Số người phụ thuộc tối đa là 10');
      }

      if (!TAX.REGIONS[regionKey]) {
        errors.push('Vùng lương không hợp lệ');
      }

      return { valid: errors.length === 0, errors };
    }

    /**
     * Get detailed tax bracket breakdown for UI display
     * @param {number} taxableIncome - Taxable income
     * @returns {Array} Breakdown by bracket
     */
    function getTaxBreakdown(taxableIncome) {
      if (taxableIncome <= 0) return [];

      const breakdown = [];
      let previousUpper = 0;

      for (const bracket of TAX.BRACKETS) {
        if (taxableIncome > previousUpper) {
          const taxableInBracket = Math.min(
            taxableIncome - previousUpper,
            bracket.upper - previousUpper
          );
          const taxInBracket = taxableInBracket * bracket.rate;

          breakdown.push({
            range: `${VND.format(previousUpper)} - ${bracket.upper === Infinity ? '...' : VND.format(bracket.upper)}`,
            rate: `${bracket.rate * 100}%`,
            taxable: taxableInBracket,
            tax: Math.round(taxInBracket)
          });

          previousUpper = bracket.upper;
          if (taxableIncome <= bracket.upper) break;
        }
      }

      return breakdown;
    }

    // Export all functions to window for testing and Phase 03 usage
    window.TAX = TAX;
    window.calculateTax = calculateTax;
    window.calculateInsurance = calculateInsurance;
    window.calculateDeductions = calculateDeductions;
    window.grossToNet = grossToNet;
    window.netToGross = netToGross;
    window.validateInputs = validateInputs;
    window.getTaxBreakdown = getTaxBreakdown;

    // ========================================
    // Phase 03: UI Interaction Logic
    // ========================================

    // Application State
    const state = {
      mode: 'gross-to-net',
      salary: 0,
      dependents: 0,
      region: 'I'
    };

    // DOM Elements
    const elements = {
      form: document.getElementById('calc-form'),
      salaryInput: document.getElementById('salary'),
      salaryType: document.getElementById('salary-type'),
      salaryError: document.getElementById('salary-error'),
      dependentsInput: document.getElementById('dependents'),
      regionSelect: document.getElementById('region'),
      modeButtons: document.querySelectorAll('.mode-btn'),
      resultLabel: document.getElementById('result-label'),
      resultValue: document.getElementById('result-value'),
      insSocial: document.getElementById('ins-social'),
      insHealth: document.getElementById('ins-health'),
      insUnemployment: document.getElementById('ins-unemployment'),
      insTotal: document.getElementById('ins-total'),
      dedPersonal: document.getElementById('ded-personal'),
      dedDependents: document.getElementById('ded-dependents'),
      dedTotal: document.getElementById('ded-total'),
      taxableIncome: document.getElementById('taxable-income'),
      taxAmount: document.getElementById('tax-amount'),
      taxRate: document.getElementById('tax-rate'),
      bracketBody: document.getElementById('bracket-body')
    };

    /**
     * Debounce utility for real-time calculation
     */
    function debounce(fn, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    /**
     * Format salary input as user types (sanitized)
     */
    function formatSalaryInput(value) {
      // Sanitize: only allow digits, dots, spaces, ₫ symbol
      const sanitized = value.replace(/[^\d.\s₫]/g, '');
      const num = VND.parse(sanitized);
      if (num === 0 && value === '') return '';
      return num.toLocaleString('vi-VN');
    }

    /**
     * Update breakdown UI with calculation result
     */
    function updateBreakdown(result) {
      elements.insSocial.textContent = VND.format(result.insurance.social);
      elements.insHealth.textContent = VND.format(result.insurance.health);
      elements.insUnemployment.textContent = VND.format(result.insurance.unemployment);
      elements.insTotal.textContent = VND.format(result.insurance.total);

      elements.dedPersonal.textContent = VND.format(TAX.PERSONAL_DEDUCTION);
      elements.dedDependents.textContent = VND.format(TAX.DEPENDENT_DEDUCTION * state.dependents);
      elements.dedTotal.textContent = VND.format(result.deductions);

      elements.taxableIncome.textContent = VND.format(result.taxableIncome);
      elements.taxAmount.textContent = VND.format(result.tax);
      elements.taxRate.textContent = result.effectiveRate + '%';
    }

    /**
     * Update tax bracket table (XSS-safe)
     */
    function updateBracketTable(taxableIncome) {
      const breakdown = getTaxBreakdown(taxableIncome);
      elements.bracketBody.textContent = '';

      if (breakdown.length === 0) {
        const emptyRow = document.createElement('tr');
        const emptyCell = document.createElement('td');
        emptyCell.colSpan = 4;
        emptyCell.style.textAlign = 'center';
        emptyCell.style.color = 'var(--color-text-muted)';
        emptyCell.textContent = 'Không có thuế';
        emptyRow.appendChild(emptyCell);
        elements.bracketBody.appendChild(emptyRow);
        return;
      }

      breakdown.forEach((item, index) => {
        const row = document.createElement('tr');
        const cellIndex = document.createElement('td');
        const cellRange = document.createElement('td');
        const cellRate = document.createElement('td');
        const cellTax = document.createElement('td');

        cellIndex.textContent = index + 1;
        cellRange.textContent = item.range;
        cellRate.textContent = item.rate;
        cellTax.textContent = VND.format(item.tax);

        row.appendChild(cellIndex);
        row.appendChild(cellRange);
        row.appendChild(cellRate);
        row.appendChild(cellTax);
        elements.bracketBody.appendChild(row);
      });
    }

    /**
     * Calculate and update UI
     */
    function calculate() {
      const validation = validateInputs(state.salary, state.dependents, state.region);

      if (!validation.valid) {
        elements.salaryError.textContent = validation.errors[0];
        elements.salaryInput.parentElement.parentElement.classList.add('has-error');
        return;
      }

      elements.salaryError.textContent = '';
      elements.salaryInput.parentElement.parentElement.classList.remove('has-error');

      let result;
      if (state.mode === 'gross-to-net') {
        result = grossToNet(state.salary, state.dependents, state.region);
        elements.resultLabel.textContent = 'Lương Net';
        elements.resultValue.textContent = VND.format(result.netIncome);
      } else {
        result = netToGross(state.salary, state.dependents, state.region);
        elements.resultLabel.textContent = 'Lương Gross';
        elements.resultValue.textContent = VND.format(result.grossIncome);
      }

      updateBreakdown(result);
      updateBracketTable(result.taxableIncome);
    }

    // Debounced calculation for real-time feedback
    const debouncedCalculate = debounce(calculate, 300);

    // ========================================
    // Event Listeners
    // ========================================

    // Salary input with VND formatting
    elements.salaryInput.addEventListener('input', (e) => {
      const formatted = formatSalaryInput(e.target.value);
      e.target.value = formatted;
      state.salary = VND.parse(formatted);
      debouncedCalculate();
    });

    // Dependents input
    elements.dependentsInput.addEventListener('change', (e) => {
      state.dependents = parseInt(e.target.value, 10) || 0;
      calculate();
    });

    // Region selector
    elements.regionSelect.addEventListener('change', (e) => {
      state.region = e.target.value;
      calculate();
    });

    // Counter buttons for dependents
    document.querySelectorAll('.counter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const action = btn.dataset.action;
        const input = elements.dependentsInput;
        let value = parseInt(input.value, 10) || 0;

        if (action === 'increment' && value < 10) value++;
        if (action === 'decrement' && value > 0) value--;

        input.value = value;
        state.dependents = value;
        calculate();
      });
    });

    // Mode toggle buttons
    elements.modeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        elements.modeButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        state.mode = btn.dataset.mode;
        elements.salaryType.textContent = state.mode === 'gross-to-net' ? 'Gross' : 'Net';

        // Clear and recalculate
        elements.salaryInput.value = '';
        state.salary = 0;
        calculate();

        // Focus management: return to salary input
        elements.salaryInput.focus();
      });
    });

    // Keyboard shortcuts for dependents input (Arrow Up/Down)
    elements.dependentsInput.addEventListener('keydown', (e) => {
      let value = parseInt(elements.dependentsInput.value, 10) || 0;

      if (e.key === 'ArrowUp' && value < 10) {
        e.preventDefault();
        value++;
        elements.dependentsInput.value = value;
        state.dependents = value;
        calculate();
      } else if (e.key === 'ArrowDown' && value > 0) {
        e.preventDefault();
        value--;
        elements.dependentsInput.value = value;
        state.dependents = value;
        calculate();
      }
    });

    // Prevent form submission
    elements.form.addEventListener('submit', (e) => {
      e.preventDefault();
    });

    // Initial calculation on page load
    calculate();
  </script>
</body>
</html>
